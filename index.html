<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ü¶∑ Mapa Escova√ß√£o Supervisionada</title>
    <link rel="icon" type="image/png" href="logo.png">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>

    <style>
        :root {
            --color-saude: #FF4B4B;
            --color-infantil: #00FF00;
            --color-fundam: #00D9FF;
            --color-outros: #FF00FF;
            --bg-gradient: linear-gradient(135deg, #0f2027, #203a43, #2c5364);
        }

        body, html { margin: 0; padding: 0; font-family: 'Inter', sans-serif; background: var(--bg-gradient); color: white; scroll-behavior: smooth; }
        
        .app-container { display: flex; min-height: 100vh; }
        
        /* Sidebar */
        .sidebar { width: 280px; background: rgba(15, 32, 39, 0.98); padding: 25px; border-right: 1px solid rgba(255,255,255,0.1); position: sticky; top: 0; height: 100vh; overflow-y: auto; }
        
        /* Conte√∫do Principal */
        .main-content { flex: 1; padding: 40px; }

        /* Cabe√ßalho */
        .header-container { 
            background: rgba(255, 255, 255, 0.07); 
            padding: 20px; 
            border-radius: 15px; 
            border: 1px solid rgba(255, 255, 255, 0.1); 
            margin-bottom: 30px; 
            display: flex; 
            align-items: center; 
        }
        .logo-box { 
            flex: 1; 
            text-align: center; 
            border-right: 1px solid rgba(255,255,255,0.1); 
            padding-right: 20px; 
        }
        .logo-img { width: 80px; height: auto; margin-bottom: 5px; }

        /* Legenda Interativa */
        .legend-box { padding: 15px; background: rgba(255,255,255,0.05); border-radius: 10px; border: 1px solid rgba(255,255,255,0.1); }
        
        .legend-item { 
            display: flex; 
            align-items: center; 
            margin-bottom: 15px; 
            font-size: 14px; 
            font-weight: 600; 
            cursor: pointer; /* Indica clic√°vel */
            transition: all 0.3s ease;
            user-select: none;
            padding: 5px;
            border-radius: 5px;
        }

        .legend-item:hover {
            background: rgba(255,255,255,0.1);
        }

        /* Classe para item desativado */
        .legend-item.inactive {
            opacity: 0.3;
            filter: grayscale(100%);
        }

        /* Classe para item fixo (n√£o interativo) */
        .legend-item.fixed {
            cursor: default;
        }
        .legend-item.fixed:hover {
            background: transparent;
        }

        .dot { height: 20px; width: 20px; border-radius: 50%; display: inline-block; margin-right: 12px; border: 2px solid white; box-shadow: 0 0 5px rgba(0,0,0,0.3); }
        .dot-mista { background: linear-gradient(90deg, var(--color-infantil) 50%, var(--color-fundam) 50%); }

        /* M√©tricas */
        .metrics-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 30px; }
        .metric-card { background: rgba(255,255,255,0.05); padding: 20px; border-radius: 12px; text-align: center; border: 1px solid rgba(255,255,255,0.05); }
        .metric-value { font-size: 28px; font-weight: bold; color: #00ffcc; margin-top: 5px; }

        /* Seletor */
        .select-box { background: rgba(255,255,255,0.05); padding: 25px; border-radius: 15px; margin-bottom: 30px; }
        label { display: block; margin-bottom: 10px; font-weight: bold; color: #00ffcc; }
        select { width: 100%; padding: 15px; background: #1a2e35; color: white; border: 1px solid rgba(0,255,204,0.3); border-radius: 10px; font-size: 16px; outline: none; }
        select:focus { border-color: #00ffcc; box-shadow: 0 0 10px rgba(0,255,204,0.2); }

        /* Mapa */
        #map { height: 650px; width: 100%; border-radius: 20px; border: 2px solid rgba(255,255,255,0.1); box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        
        #loading { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #0f2027; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 9999; }
        .spinner { border: 4px solid rgba(255,255,255,0.1); border-left-color: #00ffcc; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin-bottom: 20px; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div id="loading">
    <div class="spinner"></div>
    <h2>Carregando base de dados...</h2>
</div>

<div class="app-container">
    <aside class="sidebar">
        <h3 style="color: #00ffcc; margin-top: 0;">üìç Legenda Interativa</h3>
        <p style="font-size: 12px; margin-bottom: 15px; opacity: 0.8;">Clique nos itens abaixo para filtrar as escolas.</p>
        
        <div class="legend-box">
            <div class="legend-item fixed">
                <span class="dot" style="background: var(--color-saude); display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold;">+</span> 
                Sa√∫de (UBS/USF)
            </div>
            
            <div class="legend-item" onclick="toggleFilter('infantil', this)">
                <span class="dot" style="background: var(--color-infantil);"></span> 
                Ed. Infantil
            </div>
            
            <div class="legend-item" onclick="toggleFilter('fundamental', this)">
                <span class="dot" style="background: var(--color-fundam);"></span> 
                Ens. Fundamental
            </div>
            
            <div class="legend-item" onclick="toggleFilter('mista', this)">
                <span class="dot dot-mista"></span> 
                Mista (Inf. + Fund.)
            </div>
            
            <div class="legend-item" onclick="toggleFilter('outros', this)">
                <span class="dot" style="background: var(--color-outros);"></span> 
                Outros / M√©dio
            </div>
        </div>
        <p style="font-size: 12px; margin-top: 30px; opacity: 0.6;">Dica: Ao selecionar uma unidade no menu, o mapa focar√° automaticamente no local.</p>
    </aside>

    <main class="main-content">
        <header class="header-container">
            <div class="logo-box">
                <img src="logo.png" alt="Logo" class="logo-img" onerror="this.src='https://cdn-icons-png.flaticon.com/512/3467/3467831.png'">
                <p style="margin: 0; font-size: 14px; font-weight: bold;">iNFO SUS Mar√≠lia</p>
            </div>
            <div style="flex: 4; padding-left: 30px;">
                <h1 style="margin:0; font-size: 32px; letter-spacing: -1px;">ü¶∑ Escova√ß√£o Supervisionada na APS</h1>
                <p style="margin:5px 0 0 0; color: #00ffcc; font-weight: bold; font-size: 18px;">Gest√£o Mar√≠lia/SP</p>
            </div>
        </header>

        <section class="metrics-grid">
            <div class="metric-card"><div>Total de Escolas</div><div class="metric-value" id="count-escolas">0</div></div>
            <div class="metric-card"><div>Unidades de Sa√∫de</div><div class="metric-value" id="count-saude">0</div></div>
            <div class="metric-card"><div>Cidade</div><div class="metric-value">Mar√≠lia / SP</div></div>
        </section>

        <section class="select-box">
            <label for="unidade-select">üîç UNIDADE DE SA√öDE:</label>
            <select id="unidade-select" onchange="focarUnidade()">
                <option value="todas">--- Selecione para aproximar no mapa ---</option>
            </select>
        </section>

        <div id="map"></div>
    </main>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
    const saudeMarkers = {};
    const escolasLayers = []; // Armazena objetos { marker: L.Marker, tipo: string }
    
    // Estado inicial dos filtros (todos ativos)
    const filtrosAtivos = new Set(['infantil', 'fundamental', 'mista', 'outros']);

    const map = L.map('map').setView([-22.2139, -49.9458], 13);
    
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { 
        attribution: '¬© OpenStreetMap' 
    }).addTo(map);

    function fixCoord(val) {
        if (!val) return null;
        let fVal = parseFloat(val);
        if (isNaN(fVal)) return null;
        if (Math.abs(fVal) > 1000) {
            let sVal = Math.abs(Math.floor(fVal)).toString();
            let corrected = parseFloat(sVal.substring(0, 2) + "." + sVal.substring(2));
            return fVal < 0 ? corrected * -1 : corrected;
        }
        return fVal;
    }

    async function carregarExcel(caminho) {
        try {
            const response = await fetch(caminho);
            const arrayBuffer = await response.arrayBuffer();
            const data = new Uint8Array(arrayBuffer);
            const workbook = XLSX.read(data, { type: 'array' });
            return XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
        } catch (e) {
            console.error("Erro ao carregar: " + caminho);
            return [];
        }
    }

    // Helper para determinar a categoria padronizada e a cor
    function analisarCategoria(etapa) {
        if (!etapa) return { tipo: 'outros', color: '#FF00FF', style: '#FF00FF' };
        
        const e = etapa.toUpperCase();
        
        if (e.includes('INFANTIL') && e.includes('FUNDAMENTAL')) {
            return { tipo: 'mista', color: 'mista', style: 'linear-gradient(90deg, #00FF00 50%, #00D9FF 50%)' };
        }
        if (e.includes('INFANTIL')) {
            return { tipo: 'infantil', color: '#00FF00', style: '#00FF00' };
        }
        if (e.includes('FUNDAMENTAL')) {
            return { tipo: 'fundamental', color: '#00D9FF', style: '#00D9FF' };
        }
        
        return { tipo: 'outros', color: '#FF00FF', style: '#FF00FF' };
    }

    async function init() {
        const dadosEscolas = await carregarExcel('escolas.xlsx');
        const dadosSaude = await carregarExcel('unidades.xlsx');

        document.getElementById('count-escolas').innerText = dadosEscolas.length;
        document.getElementById('count-saude').innerText = dadosSaude.length;

        const select = document.getElementById('unidade-select');

        // --- UNIDADES DE SA√öDE (FIXAS) ---
        dadosSaude.forEach((u, index) => {
            const lat = fixCoord(u.latitude);
            const lon = fixCoord(u.longitude);
            if (lat && lon) {
                const icon = L.divIcon({
                    html: `<div style="background:#FF4B4B; width:26px; height:26px; border-radius:50%; border:2px solid white; display:flex; align-items:center; justify-content:center; color:white; font-weight:bold; box-shadow: 0 0 10px rgba(0,0,0,0.5);">+</div>`,
                    className: '', iconSize: [26, 26]
                });
                
                const marker = L.marker([lat, lon], {icon: icon})
                                .bindPopup(`<div style="color:#333"><b>UBS/USF:</b><br>${u.nome_unidade}</div>`);
                marker.addTo(map);
                
                saudeMarkers[index] = marker;

                let opt = document.createElement('option');
                opt.value = index;
                opt.innerHTML = u.nome_unidade;
                select.appendChild(opt);
            }
        });

        // --- ESCOLAS (FILTR√ÅVEIS) ---
        dadosEscolas.forEach(e => {
            const lat = fixCoord(e.Latitude);
            const lon = fixCoord(e.Longitude);
            if (lat && lon) {
                const etapaNome = e['Etapas e Modalidade de Ensino Oferecidas'] || '';
                const info = analisarCategoria(etapaNome);
                
                const icon = L.divIcon({
                    html: `<div style="background:${info.style}; width:20px; height:20px; border-radius:50%; border:2px solid white; box-shadow: 0 0 8px rgba(0,0,0,0.4);"></div>`,
                    className: '', iconSize: [20, 20]
                });
                
                const marker = L.marker([lat, lon], {icon: icon})
                                .bindPopup(`<div style="color:#333"><b>${e.Escola}</b><br><small>${etapaNome}</small></div>`);
                
                // Adiciona ao mapa inicialmente
                marker.addTo(map);

                // Salva refer√™ncia para filtrar depois
                escolasLayers.push({
                    marker: marker,
                    tipo: info.tipo
                });
            }
        });

        document.getElementById('loading').style.display = 'none';
    }

    // --- FUN√á√ÉO DE FILTRO ---
    function toggleFilter(tipo, elementoHtml) {
        // 1. Atualiza o Set de filtros ativos
        if (filtrosAtivos.has(tipo)) {
            filtrosAtivos.delete(tipo);
            elementoHtml.classList.add('inactive'); // Visualmente desligado
        } else {
            filtrosAtivos.add(tipo);
            elementoHtml.classList.remove('inactive'); // Visualmente ligado
        }

        // 2. Atualiza os marcadores no mapa
        escolasLayers.forEach(item => {
            if (filtrosAtivos.has(item.tipo)) {
                // Se o tipo est√° ativo, garante que est√° no mapa
                if (!map.hasLayer(item.marker)) {
                    item.marker.addTo(map);
                }
            } else {
                // Se o tipo est√° inativo, remove do mapa
                if (map.hasLayer(item.marker)) {
                    item.marker.remove();
                }
            }
        });
    }

    function focarUnidade() {
        const index = document.getElementById('unidade-select').value;
        
        if (index === 'todas') {
            map.setView([-22.2139, -49.9458], 13);
        } else {
            const marker = saudeMarkers[index];
            if (marker) {
                const coords = marker.getLatLng();
                map.setView(coords, 17);
                setTimeout(() => { marker.openPopup(); }, 300);
                document.getElementById('map').scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }
    }

    init();
</script>
</body>
</html>

