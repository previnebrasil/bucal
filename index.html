<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ü¶∑ Mapa Escova√ß√£o - Refer√™ncia Escolar</title>
    <link rel="icon" type="image/png" href="logo.png">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>

    <style>
        /* --- ESTILOS DO INEP.HTML (Clone Visual) --- */
        :root {
            --color-saude: #FF4B4B;
            --color-infantil: #00FF00;
            --color-fundam: #00D9FF;
            --color-outros: #FF00FF;
            --bg-gradient: linear-gradient(135deg, #0f2027, #203a43, #2c5364);
        }

        body, html { margin: 0; padding: 0; font-family: 'Inter', sans-serif; background: var(--bg-gradient); color: white; scroll-behavior: smooth; }
        
        .app-container { display: flex; min-height: 100vh; }
        
        /* Sidebar */
        .sidebar { width: 280px; background: rgba(15, 32, 39, 0.98); padding: 25px; border-right: 1px solid rgba(255,255,255,0.1); position: sticky; top: 0; height: 100vh; overflow-y: auto; display: flex; flex-direction: column; gap: 20px;}
        
        /* Conte√∫do Principal */
        .main-content { flex: 1; padding: 40px; }

        /* Cabe√ßalho */
        .header-container { 
            background: rgba(255, 255, 255, 0.07); 
            padding: 20px; 
            border-radius: 15px; 
            border: 1px solid rgba(255, 255, 255, 0.1); 
            margin-bottom: 30px; 
            display: flex; 
            align-items: center; 
        }
        .logo-box { 
            flex: 1; 
            text-align: center; 
            border-right: 1px solid rgba(255,255,255,0.1); 
            padding-right: 20px; 
        }
        .logo-img { width: 80px; height: auto; margin-bottom: 5px; }

        /* Legenda Interativa */
        .sidebar-box { padding: 15px; background: rgba(255,255,255,0.05); border-radius: 10px; border: 1px solid rgba(255,255,255,0.1); }
        
        .legend-item { 
            display: flex; align-items: center; margin-bottom: 15px; font-size: 14px; 
            font-weight: 600; cursor: pointer; transition: all 0.3s ease; user-select: none;
            padding: 5px; border-radius: 5px;
        }
        .legend-item:hover { background: rgba(255,255,255,0.1); }
        .legend-item.inactive { opacity: 0.3; filter: grayscale(100%); }
        .legend-item.fixed { cursor: default; }
        
        .dot { height: 20px; width: 20px; border-radius: 50%; display: inline-block; margin-right: 12px; border: 2px solid white; box-shadow: 0 0 5px rgba(0,0,0,0.3); }
        .dot-mista { background: linear-gradient(90deg, var(--color-infantil) 50%, var(--color-fundam) 50%); }

        /* M√©tricas */
        .metrics-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 30px; }
        .metric-card { background: rgba(255,255,255,0.05); padding: 20px; border-radius: 12px; text-align: center; border: 1px solid rgba(255,255,255,0.05); }
        .metric-value { font-size: 28px; font-weight: bold; color: #00ffcc; margin-top: 5px; }

        /* Seletor */
        .select-box { background: rgba(255,255,255,0.05); padding: 25px; border-radius: 15px; margin-bottom: 30px; }
        label { display: block; margin-bottom: 10px; font-weight: bold; color: #00ffcc; }
        select { width: 100%; padding: 15px; background: #1a2e35; color: white; border: 1px solid rgba(0,255,204,0.3); border-radius: 10px; font-size: 16px; outline: none; }
        select:focus { border-color: #00ffcc; box-shadow: 0 0 10px rgba(0,255,204,0.2); }

        /* Mapa */
        #map { height: 650px; width: 100%; border-radius: 20px; border: 2px solid rgba(255,255,255,0.1); box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        
        /* Loading */
        #loading { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #0f2027; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 9999; }
        .spinner { border: 4px solid rgba(255,255,255,0.1); border-left-color: #00ffcc; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin-bottom: 20px; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* --- NOVOS ESTILOS PARA FERRAMENTAS E MODAL (Adaptados ao Tema) --- */
        
        /* Bot√£o de A√ß√£o */
        .btn-action {
            width: 100%; padding: 15px;
            background: linear-gradient(90deg, #00D9FF, #007EA7);
            border: none; color: white; font-weight: bold; border-radius: 8px;
            cursor: pointer; margin-top: 5px; transition: 0.2s; font-size: 14px;
            text-transform: uppercase; letter-spacing: 0.5px;
            box-shadow: 0 4px 15px rgba(0, 217, 255, 0.2);
        }
        .btn-action:hover { filter: brightness(1.1); transform: translateY(-2px); }
        .btn-download {
            background: linear-gradient(90deg, #00FF00, #008f00);
            box-shadow: 0 4px 15px rgba(0, 255, 0, 0.2);
            width: auto; padding: 10px 20px;
        }

        /* Modal */
        #modal-results {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 10000;
            align-items: center; justify-content: center;
        }
        .modal-content {
            background: #1e2a33; width: 85%; max-height: 90%; padding: 30px;
            border-radius: 15px; box-shadow: 0 0 40px rgba(0,217,255,0.1);
            display: flex; flex-direction: column; border: 1px solid #444;
            position: relative;
        }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 15px; }
        .modal-title { font-size: 20px; color: #00D9FF; font-weight: bold; }
        
        .close-btn { background: none; border: none; color: white; font-size: 28px; cursor: pointer; transition: 0.2s; }
        .close-btn:hover { color: #FF4B4B; }
        
        /* Tabela */
        .table-container { overflow-y: auto; flex: 1; border-radius: 8px; border: 1px solid rgba(255,255,255,0.05); }
        table { width: 100%; border-collapse: collapse; font-size: 0.95rem; }
        th { text-align: left; padding: 15px; background: rgba(0,0,0,0.4); position: sticky; top: 0; color: #00ffcc; border-bottom: 2px solid rgba(255,255,255,0.1); }
        td { padding: 12px 15px; border-bottom: 1px solid rgba(255,255,255,0.05); color: #ddd; }
        tr:hover { background: rgba(255,255,255,0.05); }
        .km-badge { background: rgba(255, 75, 75, 0.2); color: #FF4B4B; padding: 4px 10px; border-radius: 20px; font-size: 0.85em; font-weight: bold; border: 1px solid rgba(255, 75, 75, 0.3); }

        /* Inputs escondidos mas acess√≠veis se necess√°rio */
        .input-manual { display: none; margin-top: 10px; }
        .input-manual input { width: 100%; margin-bottom: 5px; font-size: 12px; }
    </style>
</head>
<body>

<div id="loading">
    <div class="spinner"></div>
    <h2 style="color:white; font-size:1.2rem;">Carregando sistema...</h2>
    <div id="status-loading" style="color:#888; font-size:0.9rem; margin-top:10px;">Buscando bases de dados</div>
</div>

<div class="app-container">
    <aside class="sidebar">
        <div>
            <h3 style="color: #00ffcc; margin-top: 0; font-size: 1rem; text-transform: uppercase;">üìç Visualiza√ß√£o</h3>
            <p style="font-size: 12px; margin-bottom: 15px; opacity: 0.8; color:#ccc;">Filtre o que aparece no mapa:</p>
            
            <div class="sidebar-box">
                <div class="legend-item fixed">
                    <span class="dot" style="background: var(--color-saude); display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold;">+</span> 
                    Sa√∫de (UBS/USF)
                </div>
                <div class="legend-item" onclick="toggleFilter('infantil', this)">
                    <span class="dot" style="background: var(--color-infantil);"></span> 
                    Ed. Infantil
                </div>
                <div class="legend-item" onclick="toggleFilter('fundamental', this)">
                    <span class="dot" style="background: var(--color-fundam);"></span> 
                    Ens. Fundamental
                </div>
                <div class="legend-item" onclick="toggleFilter('mista', this)">
                    <span class="dot dot-mista"></span> 
                    Mista (Inf. + Fund.)
                </div>
                <div class="legend-item" onclick="toggleFilter('outros', this)">
                    <span class="dot" style="background: var(--color-outros);"></span> 
                    Outros / M√©dio
                </div>
            </div>
        </div>

        <div>
            <h3 style="color: #00ffcc; margin-top: 10px; font-size: 1rem; text-transform: uppercase;">‚ö° Ferramentas</h3>
            <div class="sidebar-box">
                <p style="font-size: 12px; opacity: 0.8; margin-top:0; color:#ccc;">
                    Cruzar dados para encontrar escolas de Ensino Fundamental mais pr√≥ximas das Unidades de Sa√∫de.
                </p>
                <button class="btn-action" onclick="gerarDistribuicao()">
                    Calcular Refer√™ncia
                </button>
            </div>
            
            <div id="manual-inputs" class="input-manual">
                <p style="font-size:11px; color:#aaa; margin-bottom:5px;">Carregamento manual:</p>
                <input type="file" id="file-unidades" accept=".xlsx" style="color:white;">
                <input type="file" id="file-escolas" accept=".xlsx" style="color:white;">
            </div>
        </div>
    </aside>

    <main class="main-content">
        <header class="header-container">
            <div class="logo-box">
                <img src="logo.png" alt="Logo" class="logo-img" onerror="this.src='https://cdn-icons-png.flaticon.com/512/3467/3467831.png'">
                <p style="margin: 0; font-size: 14px; font-weight: bold;">iNFO SUS Mar√≠lia</p>
            </div>
            <div style="flex: 4; padding-left: 30px;">
                <h1 style="margin:0; font-size: 32px; letter-spacing: -1px;">ü¶∑ Gest√£o Sa√∫de Bucal na Escola</h1>
                <p style="margin:5px 0 0 0; color: #00ffcc; font-weight: bold; font-size: 18px;">Mapeamento e Refer√™ncia</p>
            </div>
        </header>

        <section class="metrics-grid">
            <div class="metric-card"><div>Total de Escolas</div><div class="metric-value" id="count-escolas">0</div></div>
            <div class="metric-card"><div>Unidades de Sa√∫de</div><div class="metric-value" id="count-saude">0</div></div>
            <div class="metric-card"><div>Cidade</div><div class="metric-value">Mar√≠lia / SP</div></div>
        </section>

        <section class="select-box">
            <label for="unidade-select">üîç FOCALIZAR UNIDADE DE SA√öDE:</label>
            <select id="unidade-select" onchange="focarUnidade()">
                <option value="todas">--- Selecione para aproximar no mapa ---</option>
            </select>
        </section>

        <div id="map"></div>
    </main>
</div>

<div id="modal-results">
    <div class="modal-content">
        <div class="modal-header">
            <div class="modal-title">üìç Escolas de Refer√™ncia (Fundamental - 6 a 12 Anos)</div>
            <div style="display:flex; gap:15px; align-items:center;">
                <button class="btn-action btn-download" onclick="baixarXLSX()">
                    üì• Baixar Excel (.xlsx)
                </button>
                <button class="close-btn" onclick="document.getElementById('modal-results').style.display='none'">&times;</button>
            </div>
        </div>
        <div class="table-container">
            <table id="tabela-resultados">
                <thead>
                    <tr>
                        <th width="35%">Unidade de Sa√∫de</th>
                        <th width="35%">Escola Mais Pr√≥xima (Fundamental)</th>
                        <th width="15%">Modalidade</th>
                        <th width="15%">Dist√¢ncia</th>
                    </tr>
                </thead>
                <tbody>
                    </tbody>
            </table>
        </div>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    // --- Vari√°veis Globais ---
    let dadosUnidades = [];
    let dadosEscolas = [];
    let dadosCalculados = []; // Para exporta√ß√£o
    
    const saudeMarkers = {};
    const escolasLayers = []; 
    const filtrosAtivos = new Set(['infantil', 'fundamental', 'mista', 'outros']);

    // --- Mapa ---
    const map = L.map('map').setView([-22.2139, -49.9458], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    // --- Fun√ß√µes Auxiliares ---

    // Corre√ß√£o de Coordenadas (L√≥gica Inteligente)
    function fixCoord(val) {
        if (!val) return null;
        let str = String(val).replace(',', '.').trim();
        let num = parseFloat(str);
        if (isNaN(num)) return null;
        // Corrige falta de ponto decimal (ex: -222139 -> -22.2139)
        if (Math.abs(num) > 1000) {
            num = num / 10000000;
        }
        return num;
    }

    // Classifica√ß√£o da Escola (Cores e Tipos)
    function analisarCategoria(etapa) {
        if (!etapa) return { tipo: 'outros', style: '#FF00FF' };
        const e = etapa.toUpperCase();
        if (e.includes('INFANTIL') && e.includes('FUNDAMENTAL')) {
            return { tipo: 'mista', style: 'linear-gradient(90deg, #00FF00 50%, #00D9FF 50%)' };
        }
        if (e.includes('INFANTIL')) return { tipo: 'infantil', style: '#00FF00' };
        if (e.includes('FUNDAMENTAL')) return { tipo: 'fundamental', style: '#00D9FF' };
        return { tipo: 'outros', style: '#FF00FF' };
    }

    // C√°lculo de Dist√¢ncia (Haversine)
    function calcDist(lat1, lon1, lat2, lon2) {
        const R = 6371; 
        const dLat = (lat2 - lat1) * Math.PI / 180;
        const dLon = (lon2 - lon1) * Math.PI / 180;
        const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                  Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                  Math.sin(dLon/2) * Math.sin(dLon/2);
        return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    }

    // --- Carregamento e Plotagem ---

    async function carregarDados() {
        const loading = document.getElementById('loading');
        const status = document.getElementById('status-loading');
        
        try {
            // Tenta carregar automaticamente
            const [reqUnidades, reqEscolas] = await Promise.all([
                fetch('unidades.xlsx').catch(() => null),
                fetch('escolas.xlsx').catch(() => null)
            ]);

            let sucesso = true;

            // Processar Unidades
            if (reqUnidades && reqUnidades.ok) {
                const buffer = await reqUnidades.arrayBuffer();
                const wb = XLSX.read(buffer, {type: 'array'});
                dadosUnidades = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
            } else {
                sucesso = false;
                status.innerText = "Erro: 'unidades.xlsx' n√£o encontrado.";
            }

            // Processar Escolas
            if (reqEscolas && reqEscolas.ok) {
                const buffer = await reqEscolas.arrayBuffer();
                const wb = XLSX.read(buffer, {type: 'array'});
                dadosEscolas = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
            } else {
                sucesso = false;
                status.innerText = "Erro: 'escolas.xlsx' n√£o encontrado.";
            }

            if (sucesso) {
                inicializarSistema();
                loading.style.display = 'none';
            } else {
                // Se falhar, mostra input manual
                document.getElementById('manual-inputs').style.display = 'block';
                status.innerHTML = "Arquivos n√£o encontrados. Selecione manualmente na barra lateral.";
                // Adiciona listener para remover loading se carregar manual
            }
        } catch (e) {
            console.error(e);
            document.getElementById('manual-inputs').style.display = 'block';
            status.innerText = "Erro ao carregar. Use sele√ß√£o manual.";
        }
    }

    function inicializarSistema() {
        document.getElementById('count-escolas').innerText = dadosEscolas.length;
        document.getElementById('count-saude').innerText = dadosUnidades.length;
        
        const select = document.getElementById('unidade-select');
        select.innerHTML = '<option value="todas">--- Selecione para aproximar no mapa ---</option>';

        // Plotar Unidades (Vermelho)
        dadosUnidades.forEach((u, i) => {
            const lat = fixCoord(u.latitude || u.Latitude);
            const lon = fixCoord(u.longitude || u.Longitude);
            const nome = u.nome_unidade || u.Nome || 'Unidade';

            if (lat && lon) {
                const icon = L.divIcon({
                    html: `<div style="background:#FF4B4B; width:26px; height:26px; border-radius:50%; border:2px solid white; display:flex; align-items:center; justify-content:center; color:white; font-weight:bold; box-shadow: 0 0 10px rgba(0,0,0,0.5);">+</div>`,
                    className: '', iconSize: [26, 26]
                });
                const m = L.marker([lat, lon], {icon: icon})
                    .bindPopup(`<div style="color:#333"><b>UBS/USF:</b><br>${nome}</div>`)
                    .addTo(map);
                
                saudeMarkers[i] = m;
                let opt = document.createElement('option');
                opt.value = i;
                opt.text = nome;
                select.appendChild(opt);
            }
        });

        // Plotar Escolas (Coloridas)
        dadosEscolas.forEach(e => {
            const lat = fixCoord(e.Latitude);
            const lon = fixCoord(e.Longitude);
            if (lat && lon) {
                const etapa = e['Etapas e Modalidade de Ensino Oferecidas'] || '';
                const info = analisarCategoria(etapa);
                
                const icon = L.divIcon({
                    html: `<div style="background:${info.style}; width:16px; height:16px; border-radius:50%; border:2px solid white; box-shadow: 0 0 5px rgba(0,0,0,0.4);"></div>`,
                    className: '', iconSize: [16, 16]
                });

                const m = L.marker([lat, lon], {icon: icon})
                    .bindPopup(`<div style="color:#333"><b>${e.Escola}</b><br><small>${etapa}</small></div>`)
                    .addTo(map);
                
                escolasLayers.push({ marker: m, tipo: info.tipo });
            }
        });
    }

    // --- Filtros e Navega√ß√£o ---

    function toggleFilter(tipo, el) {
        if (filtrosAtivos.has(tipo)) {
            filtrosAtivos.delete(tipo);
            el.classList.add('inactive');
        } else {
            filtrosAtivos.add(tipo);
            el.classList.remove('inactive');
        }

        escolasLayers.forEach(item => {
            if (filtrosAtivos.has(item.tipo)) {
                if (!map.hasLayer(item.marker)) item.marker.addTo(map);
            } else {
                if (map.hasLayer(item.marker)) item.marker.remove();
            }
        });
    }

    function focarUnidade() {
        const val = document.getElementById('unidade-select').value;
        if (val === 'todas') {
            map.setView([-22.2139, -49.9458], 13);
        } else if (saudeMarkers[val]) {
            const m = saudeMarkers[val];
            map.setView(m.getLatLng(), 17);
            setTimeout(() => m.openPopup(), 300);
        }
    }

    // --- Ferramenta de C√°lculo e Exporta√ß√£o ---

    function gerarDistribuicao() {
        if (!dadosUnidades.length || !dadosEscolas.length) {
            alert("Os dados ainda n√£o foram carregados completamente.");
            return;
        }

        const tbody = document.querySelector('#tabela-resultados tbody');
        tbody.innerHTML = '';
        dadosCalculados = []; // Limpa dados anteriores

        // Filtrar apenas escolas que tem Fundamental
        const escolasFund = dadosEscolas.filter(e => {
            const etapa = (e['Etapas e Modalidade de Ensino Oferecidas'] || '').toLowerCase();
            return etapa.includes('fundamental');
        });

        if (escolasFund.length === 0) {
            alert("Nenhuma escola de Ensino Fundamental encontrada nos dados.");
            return;
        }

        dadosUnidades.forEach(u => {
            const uLat = fixCoord(u.latitude || u.Latitude);
            const uLon = fixCoord(u.longitude || u.Longitude);
            const uNome = u.nome_unidade || u.Nome || 'Unidade';

            if (!uLat || !uLon) return;

            let menorDist = Infinity;
            let escolaEscolhida = null;

            escolasFund.forEach(e => {
                const eLat = fixCoord(e.Latitude);
                const eLon = fixCoord(e.Longitude);
                if (eLat && eLon) {
                    const d = calcDist(uLat, uLon, eLat, eLon);
                    if (d < menorDist) {
                        menorDist = d;
                        escolaEscolhida = e;
                    }
                }
            });

            if (escolaEscolhida) {
                const distKm = menorDist.toFixed(2);
                
                // Adiciona na Tabela Visual
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td style="color:#00ffcc; font-weight:600">${uNome}</td>
                    <td style="color:white">${escolaEscolhida.Escola}</td>
                    <td style="font-size:0.8em; color:#aaa;">${escolaEscolhida['Etapas e Modalidade de Ensino Oferecidas']}</td>
                    <td><span class="km-badge">${distKm} km</span></td>
                `;
                tbody.appendChild(tr);

                // Adiciona na Lista para Exporta√ß√£o
                dadosCalculados.push({
                    "Unidade de Sa√∫de": uNome,
                    "Latitude US": uLat,
                    "Longitude US": uLon,
                    "Escola Refer√™ncia (Fundamental)": escolaEscolhida.Escola,
                    "Modalidades da Escola": escolaEscolhida['Etapas e Modalidade de Ensino Oferecidas'],
                    "Dist√¢ncia (km)": parseFloat(distKm)
                });
            }
        });

        document.getElementById('modal-results').style.display = 'flex';
    }

    function baixarXLSX() {
        if (dadosCalculados.length === 0) {
            alert("Nenhum dado calculado para baixar.");
            return;
        }

        // Cria planilha a partir do JSON
        const ws = XLSX.utils.json_to_sheet(dadosCalculados);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Referencias");

        // Gera arquivo e baixa
        XLSX.writeFile(wb, "Relatorio_Referencia_Escolar.xlsx");
    }

    // --- Inputs Manuais (Fallback) ---
    function lerArquivoManual(e, tipo) {
        const reader = new FileReader();
        reader.onload = (ev) => {
            const wb = XLSX.read(ev.target.result, {type:'array'});
            const dados = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
            
            if (tipo === 'unidades') dadosUnidades = dados;
            else dadosEscolas = dados;

            if (dadosUnidades.length && dadosEscolas.length) {
                inicializarSistema();
                document.getElementById('loading').style.display = 'none';
            }
        };
        reader.readAsArrayBuffer(e.target.files[0]);
    }

    document.getElementById('file-unidades').addEventListener('change', (e) => lerArquivoManual(e, 'unidades'));
    document.getElementById('file-escolas').addEventListener('change', (e) => lerArquivoManual(e, 'escolas'));

    // In√≠cio
    window.addEventListener('DOMContentLoaded', carregarDados);

</script>
</body>
</html>